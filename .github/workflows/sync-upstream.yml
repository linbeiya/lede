name: Sync with Upstream LEDE and Auto Build H68K

on:
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´10ç‚¹ï¼ˆUTC2ç‚¹ï¼‰è‡ªåŠ¨æ£€æŸ¥æ›´æ–°

env:
  UPSTREAM_REPO: coolsnowwolf/lede
  UPSTREAM_BRANCH: master
  TARGET_BRANCH: master
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync-upstream:
    runs-on: ubuntu-22.04
    outputs:
      has-update: ${{ steps.sync.outputs.has-update }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

    - name: Sync with upstream
      id: sync
      run: |
        echo "ğŸ” æ£€æŸ¥ä¸Šæ¸¸ LEDE æºç æ›´æ–°..."
        
        # æ·»åŠ ä¸Šæ¸¸ä»“åº“
        git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
        git fetch upstream ${{ env.UPSTREAM_BRANCH }}
        
        # è·å–æäº¤ä¿¡æ¯
        UPSTREAM_COMMIT=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})
        CURRENT_COMMIT=$(git rev-parse HEAD)
        
        echo "ä¸Šæ¸¸æœ€æ–°æäº¤: $UPSTREAM_COMMIT"
        echo "å½“å‰æäº¤: $CURRENT_COMMIT"
        
        if [ "$UPSTREAM_COMMIT" = "$CURRENT_COMMIT" ]; then
          echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          echo "has-update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ğŸ”„ å‘ç°ä¸Šæ¸¸æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
        echo "has-update=true" >> $GITHUB_OUTPUT
        
        # å¤‡ä»½ H68K é…ç½®æ–‡ä»¶
        echo "ğŸ“¦ å¤‡ä»½ H68K é…ç½®æ–‡ä»¶..."
        mkdir -p .h68k-backup
        cp .config .h68k-backup/ 2>/dev/null || echo "âš ï¸ .config ä¸å­˜åœ¨"
        cp .config.minimal .h68k-backup/ 2>/dev/null || echo "âš ï¸ .config.minimal ä¸å­˜åœ¨"
        cp diy-part*.sh .h68k-backup/ 2>/dev/null || echo "âš ï¸ diy-part*.sh ä¸å­˜åœ¨"
        cp H68K-README.md .h68k-backup/ 2>/dev/null || echo "âš ï¸ H68K-README.md ä¸å­˜åœ¨"
        cp monitor-disk-space.sh .h68k-backup/ 2>/dev/null || echo "âš ï¸ monitor-disk-space.sh ä¸å­˜åœ¨"
        cp -r .github .h68k-backup/ 2>/dev/null || echo "âš ï¸ .github ç›®å½•ä¸å­˜åœ¨"
        
        # è·å–æ›´æ–°æ—¥å¿—
        echo "ğŸ“ ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
        echo "# ğŸ”„ LEDE æºç è‡ªåŠ¨æ›´æ–°æ—¥å¿—" > UPDATE_LOG.md
        echo "" >> UPDATE_LOG.md
        echo "**æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> UPDATE_LOG.md
        echo "**ä¸Šæ¸¸ä»“åº“**: https://github.com/${{ env.UPSTREAM_REPO }}" >> UPDATE_LOG.md
        echo "**æ›´æ–°æäº¤**: $UPSTREAM_COMMIT" >> UPDATE_LOG.md
        echo "" >> UPDATE_LOG.md
        echo "## ğŸ“‹ æ›´æ–°å†…å®¹" >> UPDATE_LOG.md
        git log --oneline --no-merges $CURRENT_COMMIT..$UPSTREAM_COMMIT | head -20 >> UPDATE_LOG.md
        
        # å°è¯•åˆå¹¶ä¸Šæ¸¸æ›´æ–°
        echo "ğŸ”€ åˆå¹¶ä¸Šæ¸¸æ›´æ–°..."
        if git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit; then
          echo "âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ"
        else
          echo "âš ï¸ è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œä½¿ç”¨å¼ºåˆ¶æ›´æ–°ç­–ç•¥"
          git merge --abort
          git reset --hard upstream/${{ env.UPSTREAM_BRANCH }}
        fi
        
        # æ¢å¤ H68K é…ç½®æ–‡ä»¶
        echo "ğŸ”§ æ¢å¤ H68K é…ç½®æ–‡ä»¶..."
        cp .h68k-backup/.config . 2>/dev/null || echo "âš ï¸ æ¢å¤ .config å¤±è´¥"
        cp .h68k-backup/.config.minimal . 2>/dev/null || echo "âš ï¸ æ¢å¤ .config.minimal å¤±è´¥"
        cp .h68k-backup/diy-part*.sh . 2>/dev/null || echo "âš ï¸ æ¢å¤ diy-part*.sh å¤±è´¥"
        cp .h68k-backup/H68K-README.md . 2>/dev/null || echo "âš ï¸ æ¢å¤ H68K-README.md å¤±è´¥"
        cp .h68k-backup/monitor-disk-space.sh . 2>/dev/null || echo "âš ï¸ æ¢å¤ monitor-disk-space.sh å¤±è´¥"
        cp -r .h68k-backup/.github . 2>/dev/null || echo "âš ï¸ æ¢å¤ .github å¤±è´¥"
        
        # æ¸…ç†å¤‡ä»½
        rm -rf .h68k-backup
        
        # æäº¤æ›´æ–°
        git add .
        git commit -m "Auto sync upstream LEDE - $(date '+%Y-%m-%d %H:%M:%S')" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"

        # æ¨é€æ›´æ–°
        git push origin ${{ env.TARGET_BRANCH }}

        echo "âœ… åŒæ­¥å®Œæˆï¼"

  trigger-build:
    needs: sync-upstream
    if: needs.sync-upstream.outputs.has-update == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-22.04

    steps:
    - name: Trigger H68K build workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('è§¦å‘ H68K å›ºä»¶ç¼–è¯‘...');

          const result = await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'openwrt-ci.yml',
            ref: '${{ env.TARGET_BRANCH }}'
          });

          console.log('H68K ç¼–è¯‘ä»»åŠ¡å·²è§¦å‘');
